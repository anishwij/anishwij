---
config:
  theme: neo-dark
  look: handDrawn
---


sequenceDiagram
      autonumber
      actor Browser as User
      participant Next.js (Server)
      participant Redis
      participant Meta
      participant PostHog
      participant Stripe
      Browser->>+Next.js (Server): Land with UTMs
      activate Next.js (Server)
      Next.js (Server)->>+Redis: Create Session
      Redis-->>-Next.js (Server): Session Created
      Next.js (Server)->>Next.js (Server): Clean URL (remove UTMs)
      par Analytics
        Next.js (Server)->>Meta: Send PageView
      and
        Next.js (Server)->>PostHog: Send PageView
      end
      Next.js (Server)-->>-Browser: Page Loaded (clean URL)
      Browser->>+Next.js (Server): View Content
      activate Next.js (Server)
      Next.js (Server)->>+Redis: Update Session
      Redis-->>-Next.js (Server): Session Updated
      par Analytics
        Next.js (Server)->>Meta: Send ViewContent
      and
        Next.js (Server)->>PostHog: Send ViewContent
      end
      deactivate Next.js (Server)
      Browser->>+Next.js (Server): Click Donate
      activate Next.js (Server)
      Next.js (Server)->>+Stripe: Create Checkout Session<br/>(with sessionId metadata)
      Stripe-->>-Next.js (Server): Checkout URL
      Next.js (Server)-->>-Browser: Redirect to Stripe
      Note over Stripe: Customer completes payment
      Stripe->>+Next.js (Server): Webhook (success)
      activate Next.js (Server)
      Next.js (Server)->>Next.js (Server): Validate webhook signature
      Next.js (Server)->>Next.js (Server): Extract sessionId from metadata
      Next.js (Server)->>+Redis: Get Session Data
      Redis-->>-Next.js (Server): Session Data
      Next.js (Server)->>Next.js (Server): Calculate conversion value
      Next.js (Server)->>+Redis: Mark Converted
      Redis-->>-Next.js (Server): Updated
      par Analytics
        Next.js (Server)->>Meta: Send Purchase Event<br/>(with value data)
      and
        Next.js (Server)->>PostHog: Send Conversion
      end
      deactivate Next.js (Server)
      Next.js (Server)-->>Browser: Success Page